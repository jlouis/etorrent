# See COPYING for license
# Copyright 2007 Jesper Louis Andersen <jesper.louis.andersen@gmail.com>

# This file is currently a bit hackish. There is quite some infrastructure
# to develop before it looks neat. Basicly, you steal from the otp-src releases
# until you have something neater. If done right, the source becomes a bliss
# to maintain.

### ETORRENT_SPECIFIC_STUFF
RELEASEDIR = releases/1.0
CONFIGURATION_DIR = etc
BINARY_DIR = bin

ETORRENT_1.0_SRCDIR = lib/etorrent-1.0/src
ETORRENT_1.0_EBINDIR = lib/etorrent-1.0/ebin


ETORRENT_1.0_MODULES = etorrent_listener etorrent_t_pool_sup etorrent_acceptor \
	etorrent_metainfo etorrent_tracker_communication etorrent_bcoding \
	etorrent_app etorrent_t_state \
	etorrent_dirwatcher etorrent_sup etorrent_t_sup \
	etorrent_dirwatcher_sup \
	etorrent_peer_communication etorrent_utils etorrent_fs_checker \
	etorrent_t_control \
	etorrent_fs etorrent_t_manager http_gzip \
	etorrent_fs_process \
	etorrent_t_peer_group etorrent_fs_serializer etorrent_t_peer_recv \
	etorrent_histogram \
	etorrent_t_peer_pool_sup \
	etorrent_t_peer_send \
	etorrent_event \
	etorrent_acceptor_sup \
	etorrent_fs_pool_sup \
	etorrent_mnesia_init etorrent_mnesia_operations

ETORRENT_1.0_SOURCES = $(ETORRENT_1.0_MODULES:%=$(ETORRENT_1.0_SRCDIR)/%.erl)

ETORRENT_1.0_BEAMS = $(ETORRENT_1.0_MODULES:%=$(ETORRENT_1.0_EBINDIR)/%.beam)

ETORRENT_1.0_APP = $(ETORRENT_1.0_SRCDIR)/etorrent.app

ETORRENT_PROG_NAME = etorrent
CONFIGURATION_FILE = $(ETORRENT_PROG_NAME:%=$(CONFIGURATION_DIR)/%.config)
ETORRENTCTL_FILE   = $(BINARY_DIR)/etorrentctl
RELEASE_FILE       = $(ETORRENT_PROG_NAME:%=$(RELEASEDIR)/%.rel)
BOOT_FILE          = $(ETORRENT_PROG_NAME:%=$(RELEASEDIR)/%.boot)
SCRIPT_FILE        = $(ETORRENT_PROG_NAME:%=$(RELEASEDIR)/%.script)

### IMPLICIT RULES

# Kill all suffixes, sans those we define.
.SUFFIXES :
.SUFFIXES : .erl .beam .rel .boot .script

$(ETORRENT_1.0_EBINDIR)/%.beam: $(ETORRENT_1.0_SRCDIR)/%.erl
	$(ERLC) $(ERLCFLAGS) -o$(ETORRENT_1.0_EBINDIR) -b beam $<

$(RELEASEDIR)/%.boot : $(RELEASEDIR)/%.rel
	$(ERLC) $(ERLCFLAGS) -o$(RELEASEDIR) -b boot $<

$(RELEASEDIR)/%.script : $(RELEASEDIR)/%.rel
	$(ERLC) $(ERLCFLAGS) -o$(RELEASEDIR) -b script $<



### GENERIC AUTOCONF STUFF
SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@

INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@
LN_S    = @LN_S@

ERLC = @ERLC@
ERL = @ERL@

ERLCFLAGS = @ERLCFLAGS@

ERLANG_ROOT_DIR = @ERLANG_ROOT_DIR@
ERLANG_LIB_DIR  = @ERLANG_LIB_DIR@
ERLANG_INSTALL_LIB_DIR = @ERLANG_INSTALL_LIB_DIR@
ERLANG_INSTALL_LIB_DIR_etorrent = @ERLANG_INSTALL_LIB_DIR_etorrent@
etorrent_EBIN = $(ERLANG_INSTALL_LIB_DIR_etorrent)/ebin

DESTDIR =
BINDIR = @bindir@
DOCDIR = @docdir@
SYSCONFDIR = @sysconfdir@
DATAROOTDIR = @datarootdir@
libdir = @libdir@

INST_BEAMDIR = $(etorrent_EBIN)
#INST_RELEASEDIR = $(ERLANG_ROOT_DIR)/
#INST_RELEASEDIR = $(ETORRENTDIR)/releases


### TARGETS

.PHONY: all
all: beams

.PHONY: beams
beams: etorrent-1.0-beams

.PHONY: bootscript
bootscript: release-1.0

.PHONY: release-1.0
release-1.0: etorrent-1.0-beams $(BOOT_FILE) $(SCRIPT_FILE)

.PHONY: etorrent-1.0-beams
etorrent-1.0-beams: $(ETORRENT_1.0_BEAMS)

.PHONY: dialyzer
dialyzer: beams
	dialyzer -c $(ETORRENT_1.0_EBINDIR)

.PHONY: clean
clean:
	rm -f $(ETORRENT_1.0_BEAMS) $(BOOT_FILE) $(SCRIPT_FILE)
	cd doc && $(MAKE) clean

.PHONY: install
install: all
	$(MKDIR_P) $(INST_BEAMDIR)
	$(INSTALL) -m 644 $(ETORRENT_1.0_BEAMS) $(INST_BEAMDIR)
	$(INSTALL) -m 644 $(ETORRENT_1.0_APP)   $(INST_BEAMDIR)

	$(MKDIR_P) $(BINDIR)
	$(INSTALL) -m 755 $(ETORRENTCTL_FILE) $(BINDIR)

	$(MKDIR_P) $(SYSCONFDIR)
	$(INSTALL) -m 644 $(CONFIGURATION_FILE) $(SYSCONFDIR)

#	$(INSTALL) -d $(INST_RELEASEDIR)
#	$(INSTALL) -m 644 $(BOOT_FILE) $(INST_RELEASEDIR)
#	$(INSTALL) -m 644 $(SCRIPT_FILE) $(INST_RELEASEDIR)

